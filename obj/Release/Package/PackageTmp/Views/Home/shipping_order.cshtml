@model WatanART.BLL.ViewModels.OrderVM
@{
    ViewBag.Title = "shipping_order";
    Layout = "~/Views/Shared/_WebSiteLayout.cshtml";
}

<div class="page shipping">
    <div class="container">
        <h3 class="page-title">@WatanART.Localization.Resource.ShippingOrder</h3>
        <div class="row">
            <div class="col-md-8">
  
                    <div class="form-group">
                        <input type="text" id="txt_address" class="form-control" placeholder="@WatanART.Localization.Resource.Address">
                    </div>

                <div class="form-group">
                    <input type="text" id="PhoneNumber" class="form-control" value="@ViewBag.userphonenumber"   data-bv-notempty="true"
                data-bv-notempty-message=@WatanART.Localization.Resource.Required placeholder="@WatanART.Localization.Resource.PhoneNumber">
                </div>
                    <div class="form-group">
                        <select id="CountryID" class="form-control" name="CountryID" required data-bv-notempty="true" onchange="viewCities();">
                            <option value="-1">@WatanART.Localization.Resource.ChooseCountry</option>
                            @foreach (SelectListItem item in ((IEnumerable<SelectListItem>)ViewData["allcountries"]))
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-control select2" id="cityid"
                                data-bv-notempty="true"
                                data-bv-notempty-message=@WatanART.Localization.Resource.Required>
                            <option value="-1">@WatanART.Localization.Resource.ChooseCity</option>
                        </select>

                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" id="txt_Coupon" placeholder="@WatanART.Localization.Resource.PromoCode">
                        <button  class="btn btn-primary col-md-3" onclick="CheckPromoCode();">@WatanART.Localization.Resource.CheckPromoCode</button>
                        <div class="col-md-5 t-price"> <span>Total Price :</span><span id="totalprice"></span> <span style="display:none" id="totalprice2"></span></div>
                    </div>
                    @*<p>Price of shipping : 100$</p>*@
                    @*<p>Total Delivery in 4-8 days: <span id="totalDelivery"> 0 </span> $</p>*@
                    <h4>@WatanART.Localization.Resource.PaymentMethod</h4>
                    <hr />

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exampleRadios" value="1" checked>
                        <label class="form-check-label" for="exampleRadios1">
                            @WatanART.Localization.Resource.Cash
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exampleRadios" value="2">
                        <label class="form-check-label" for="exampleRadios1">
                            @WatanART.Localization.Resource.Online
                        </label>
                    </div>
                    <button class="btn btn-primary complete" onclick="beformakeorder();">@WatanART.Localization.Resource.Complete</button>
                <br />
                <br />
            </div>
            <div class="col-md-4 shipping-sidebar">
                <div class="container">
                    <div class="row" id="ordershipping_container">
                       
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
<script>

    $(document).ready(function () {
        debugger;
        var htmlContent = "";

        IOBreadcrumb.breadcrumbs = JSON.parse(window.localStorage.getItem("arryobj"));
        @* var MakeOrderPatterns = JSON.parse(window.localStorage.getItem("arrPattern"));
        var MakeOrderNumbers = JSON.parse(window.localStorage.getItem("arrNumbers"));
        var totalPrice = parseInt(JSON.parse(window.localStorage.getItem("totalPrice"))) * @ViewBag.OnePiecePrice +@ViewBag.ThreePiecePrice;
        $("#totalDelivery").text(totalPrice);*@

        for (var i = 0; i < IOBreadcrumb.breadcrumbs.length; i++) {
            var imageOrder = "imageOrder" + i;
            htmlContent += '<div class="col-md-4" id="indeximage'+i+'">';
            htmlContent += '<button type="button" class="close" onclick="removeItem(' + i + ')"  aria-label="Close"><span aria-hidden="true">&times;</span></button>';
            htmlContent += '<div class="card bg-dark text-white">';
            htmlContent += '<img class="card-img" src="' + IOBreadcrumb.breadcrumbs[i].croppedimage + '">';
            htmlContent += '</div>';
            //htmlContent += '<p class="sizes">8" x 12"</p>';
            htmlContent += '<div class="control d-flex">';
            htmlContent += '<input  class="patternNumber"  type="number" id="' + imageOrder + '" min="1" onclick="testEquation(' + i + ')" value="' + IOBreadcrumb.breadcrumbs[i].imagecount + '">';
            htmlContent += '</div>';
            htmlContent += '</div>';
        }
        $("#ordershipping_container").html(htmlContent);


        totalprice();


        $('.patternNumber').on('input', function () {
            var m = $(this).val();
            if (m && m > 0) {
                totalprice();
            } else {
                $(this).val(1);
                totalprice();
            }
        });



       

    });

    function removeItem(item) {

        debugger;
        IOBreadcrumb.breadcrumbs.splice(item, 1);
        $("#indeximage" + item).remove();
        //$(this).closest('.col-md-4').remove();
        //$(this).parent('.imageitem').remove();
        window.localStorage.setItem("arryobj", JSON.stringify(IOBreadcrumb.breadcrumbs));
        totalprice();



    }

    function returnHomePage() {
        window.location.href = "/home/index";
    }

    var uploadedImages = [];
    function beformakeorder() {

        debugger;
        var userid = getCookie("UserID");
        var address = $("#txt_address").val();
        var Coupon = $("#txt_Coupon").val();
        var cityID = $("#cityid").val();
        var CountryID = $("#CountryID").val();
        var PhoneNumber = $("#PhoneNumber").val();
        
        var lenth = $('input.patternNumber').length;


        if (lenth > 0) {

        }
        else {
            Show_Alert('Confirmation', 'info', "@WatanART.Localization.Resource.MoreImagesRequired", true, 'Ok', '', false, '', '', false, '', '', null, null, null);
            return false;
        }

        if (userid) {

        }
        else {
            Show_Alert('Confirmation', 'info', "@WatanART.Localization.Resource.PleaseLogin", true, 'Ok', '', false, '', '', false, '', '', null, null, null);
            return false;
        }





        if (address.trim() == "" || PhoneNumber.trim() == "" || cityID == "-1" || CountryID == "-1") {

            if (address.trim() == "") {
                $('#txt_address').css('border-color', 'red');
            }
            else {
                $('#txt_address').css('border-color', '');
            }

            if (PhoneNumber.trim() == "") {
                $('#PhoneNumber').css('border-color', 'red');
            }
            else {
                $('#PhoneNumber').css('border-color', '');
            }


            if (CountryID == "-1") {
                $('#CountryID').css('border-color', 'red');
            }
            else {
                $('#CountryID').css('border-color', '');
            }


            if (cityID == "-1") {
                $('#cityid').css('border-color', 'red');
            }
            else {
                $('#cityid').css('border-color', '');
            }





            return false;
        }



        var makeorderImagesArr = [];
        var extensionArr = [];
        for (var item in IOBreadcrumb.breadcrumbs) {
            makeorderImagesArr.push(IOBreadcrumb.breadcrumbs[item].croppedimage);
            extensionArr.push(IOBreadcrumb.breadcrumbs[item].croppedimage.substring(IOBreadcrumb.breadcrumbs[item].croppedimage.indexOf('/') + 1, IOBreadcrumb.breadcrumbs[item].croppedimage.indexOf(';base64')));
        }

        var url = "/api/FileUploader/SaveFileLst";
        if (makeorderImagesArr.length > 0) {
            var addExperienceImageParam = { filePath: makeorderImagesArr, imageExten: extensionArr }
            var jsonObj2 = JSON.stringify(addExperienceImageParam);
            $.ajax({
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                url: url,
                async: false,
                data: jsonObj2,
                success: function (data) {
                    //alert(data.result)
                    uploadedImages = data.result; // Saving
                    //window.localStorage.setItem("arrPattern", JSON.stringify(patternArr));
                    //window.localStorage.setItem("arrNumbers", JSON.stringify(NumbersArr));
                    //window.localStorage.setItem("totalPrice", JSON.stringify(total));
                    makeOrder();
                    //window.location.href = "/home/shipping_order";
                },
                error: function () {
                    alert("Error");
                }
            });
        }


    }

    function findObjectByKey(value) {
        debugger;
        var mypatrenArray = [{ 'id': '1', 'foo': 'aspectRatio1' }, { 'id': '5', 'foo': 'aspectRatio2' }, { 'id': '2', 'foo': 'aspectRatio3' }, { 'id': '3', 'foo': 'aspectRatio4' }, { 'id': '6', 'foo': 'aspectRatio5' }, { 'id': '4', 'foo': 'aspectRatio6' }]
        for (var i = 0; i < mypatrenArray.length; i++) {
            if (mypatrenArray[i]['foo'] === value) {
                return mypatrenArray[i]['id'];
            }
        }
        return null;
    }

    var inegypt = false;

    function makeOrder() {
        var userid = getCookie("UserID");
        var address = $("#txt_address").val();
        var Coupon = $("#txt_Coupon").val();
        var cityID = $("#cityid").val();
        var CountryID = $("#CountryID").val();
        var PhoneNumber = $("#PhoneNumber").val();
        var paytype = $('input[name=exampleRadios]:checked').val();
        var orderdetailsArr = [];

        // var MakeOrderImages = JSON.parse(window.localStorage.getItem("arrImages"));
        //var MakeOrderPatterns = JSON.parse(window.localStorage.getItem("arrPattern"));
        //var MakeOrderNumbers = JSON.parse(window.localStorage.getItem("arrNumbers"));
        debugger;
        for (var i = 0; i < IOBreadcrumb.breadcrumbs.length; i++) {
            var paterinid = findObjectByKey(IOBreadcrumb.breadcrumbs[i].pattern); //mypatrenArray.find(x => x.foo === IOBreadcrumb.breadcrumbs[i].pattern).id;
            orderdetailsArr.push({ "mainImage": uploadedImages[i], "quantiy": IOBreadcrumb.breadcrumbs[i].imagecount, "patternID": paterinid });
        }

        var MethodParam = { "order": { "userID": userid, "countryID": CountryID, "cityID": cityID, "address1": address, "address2": address, "zipcode": "11111", "couponCode": Coupon, "buytype": 1, "InEgypt": true, "buytype": paytype, "PhoneNumber": PhoneNumber }, "orderDetils": orderdetailsArr }
        $.ajax({
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            async: false,
            data: JSON.stringify(MethodParam),
            url: "/api/OrderAPI/MakeOrder",
            success: function (data) {
                if (paytype == 2) {
                    console.log(data);
                    debugger;
                    var href = "/Payment/PaymentOrder?OrderId=" + parseInt(data.result) + "&lang=1";
                    window.location.href = href;
                } else {
                    localStorage.clear();
                    Show_Alert('Confirmation', 'info', "تم الإرسال بنجاح", true, 'Ok', '', false, '', '', false, '', '',
                    returnHomePage, null, null);
                }

            }
        });
    }



    function CheckPromoCode() {
        debugger;
        var Coupon = $("#txt_Coupon").val();
        var userid = getCookie("UserID");
        if (userid) {
            if (Coupon && Coupon != "") {
                var MethodParam = { "UserID": userid, "couponCode": Coupon }
                $.ajax({
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    async: false,
                    data: JSON.stringify(MethodParam),
                    url: "/home/CheckPromoCode",
                    success: function (data) {
                        debugger;
                        if (data < 1) {
                            $("#txt_Coupon").val("");
                            Show_Alert('Confirmation', 'info', "@WatanART.Localization.Resource.Invalidcode", true, 'Ok', '', false, '', '', false, '', '', null, null, null);
                        }
                        else {
                            var totalprice = $("#totalprice2").text();
                            $("#totalprice").text(parseFloat(totalprice) - (parseFloat(totalprice) * (parseFloat(@ViewBag.Discount) / 100)));
                        }

                    }
                });
            } else {
                Show_Alert('Confirmation', 'info', "@WatanART.Localization.Resource.Invalidcode", true, 'Ok', '', false, '', '', false, '', '', null, null, null);
                //return false;

            }

        } else {
            Show_Alert('Confirmation', 'info', "@WatanART.Localization.Resource.PleaseLogin", true, 'Ok', '', false, '', '', false, '', '', null, null, null);
            //return false;

        }


    }


    function testEquation(i) {
        var patternval = $("#imageOrder" + i).val();
        var total = patternval * 10;//+ parseInt($("#totalDelivery").text());
        $("#totalDelivery").text(total);
    }

    var country = "EG";
    
    function totalprice() {
        var checktotal = 0;
        var totalprice = 0;
        var m = 0;
        $('input.patternNumber').each(function (index) {
            debugger;
            m =  parseInt($(this).val());
            IOBreadcrumb.breadcrumbs[index].imagecount = m;
            if (IOBreadcrumb.breadcrumbs[index].pattern == "aspectRatio4" || IOBreadcrumb.breadcrumbs[index].pattern == "aspectRatio5" || IOBreadcrumb.breadcrumbs[index].pattern == "aspectRatio6") {
                m = m * 3;

            }


            checktotal += parseInt(m);
        });
        if (country == "EG") {
            if (checktotal >= 3) {
                totalprice += parseInt('@ViewBag.ThreePiecePrice');
                checktotal = checktotal - 3;
            }
            totalprice += (checktotal * parseInt('@ViewBag.OnePiecePrice'))
            totalprice += " LE";
            inegypt=true;
        } else {
            if (checktotal >= 3) {
                totalprice += parseInt('@ViewBag.wThreePiecePrice');
                checktotal = checktotal - 3;
            }
            totalprice += (checktotal * parseInt('@ViewBag.wOnePiecePrice'))
            totalprice += " $";
            inegypt=false;
        }

        console.log('@ViewBag.ThreePiecePrice');
        console.log('@ViewBag.OnePiecePrice');
        console.log(checktotal);
        $("#totalprice").text(totalprice);

        $("#totalprice2").text(totalprice);
    }


    $.getJSON('https://ipinfo.io/json', function (data) {
        console.log(JSON.stringify(data, null, 2));
        country = data.country;
        console.log(country);
       
        //country
    }).fail(function () {
        country = "EG";
        console.log(country);
    });
</script>
}